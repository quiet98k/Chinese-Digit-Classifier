<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Draw and Predict</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #fff;
        color: #000;
      }
      canvas {
        border: 1px solid black;
        background-color: black;
      }
      .controls {
        margin-top: 10px;
      }
      #chart-container {
        width: 400px;
        height: 400px;
        margin-top: 20px;
        display: none;
      }
      .prediction-info {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>Draw a Digit</h1>
    <div class="prediction-info" id="prediction-info">
      <!-- Prediction label, Chinese character, and English meaning will appear here -->
    </div>
    <canvas id="canvas" width="280" height="280"></canvas>
    <div class="controls">
      <button onclick="clearCanvas()">Clear</button>
      <button onclick="predict()">Predict</button>
    </div>
    <p id="result"></p>
    <div id="chart-container">
      <canvas id="confidence-chart"></canvas>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      let drawing = false;

      // Set the initial canvas background to black
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      canvas.addEventListener("mousedown", () => (drawing = true));
      canvas.addEventListener("mouseup", () => {
        drawing = false;
        ctx.beginPath(); // Reset the path after each stroke
      });
      canvas.addEventListener("mousemove", draw);

      function draw(event) {
        if (!drawing) return;
        ctx.lineWidth = 10;
        ctx.lineCap = "round";
        ctx.strokeStyle = "white"; // Set pen color to white
        ctx.lineTo(
          event.clientX - canvas.offsetLeft,
          event.clientY - canvas.offsetTop
        );
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(
          event.clientX - canvas.offsetLeft,
          event.clientY - canvas.offsetTop
        );
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "black"; // Set fill color to black
        ctx.fillRect(0, 0, canvas.width, canvas.height); // Fill the canvas with black
        ctx.beginPath();
        document.getElementById("result").innerText = ""; // Clear the result text
        document.getElementById("chart-container").style.display = "none"; // Hide the chart
        document.getElementById("prediction-info").innerHTML = ""; // Clear the prediction info
      }

      function predict() {
        const dataURL = canvas.toDataURL("image/png");

        fetch("/predict", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ image: dataURL }),
        })
          .then((response) => response.json())
          .then((data) => {
            const prediction = data.prediction;
            const chineseDigits = [
              "零",
              "一",
              "二",
              "三",
              "四",
              "五",
              "六",
              "七",
              "八",
              "九",
              "十",
              "百",
              "千",
              "万",
              "亿",
            ];
            const chineseCharacter = chineseDigits[prediction];

            const englishMeaning = [
              "Zero",
              "One",
              "Two",
              "Three",
              "Four",
              "Five",
              "Six",
              "Seven",
              "Eight",
              "Nine",
              "Ten",
              "Hundred",
              "Thousand",
              "Ten Thousand",
              "Hundred Million",
            ];

            const meaning = englishMeaning[prediction];

            // Display prediction, Chinese character, and English meaning at the top
            document.getElementById("prediction-info").innerHTML = `
              <p>Prediction Label: ${prediction}</p>
              <p>Chinese Character: ${chineseCharacter}</p>
              <p>English Meaning: ${meaning}</p>
            `;

            // Create the confidence chart
            const ctx = document
              .getElementById("confidence-chart")
              .getContext("2d");
            const labels = Array.from({ length: 15 }, (_, i) => i.toString());
            const chartData = {
              labels: labels,
              datasets: [
                {
                  label: "Confidence",
                  data: data.confidences,
                  backgroundColor: "rgba(255, 255, 255, 0.6)", // Semi-transparent white for bars
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1,
                },
              ],
            };
            const config = {
              type: "bar",
              data: chartData,
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(255, 255, 255, 0.2)", // Subtle white grid lines
                    },
                    ticks: {
                      color: "black", // White Y-axis ticks
                    },
                  },
                  x: {
                    ticks: {
                      color: "black", // White X-axis ticks
                    },
                  },
                },
                plugins: {
                  legend: {
                    labels: {
                      color: "black", // Ensure legend text color is black
                    },
                  },
                },
                elements: {
                  title: {
                    display: true,
                    text: "Confidence Chart", // Chart title
                    color: "black", // Set title text color to black
                    font: {
                      size: 16, // Set title font size
                    },
                  },
                },
              },
              plugins: [
                {
                  beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext("2d");
                    ctx.save();
                    ctx.globalCompositeOperation = "destination-over";
                    ctx.fillStyle = "white"; // Set chart background to white
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                  },
                },
              ],
            };

            // Destroy existing chart if it exists and create a new one
            if (window.myChart) {
              window.myChart.destroy(); // Destroy the existing chart if it exists
            }
            window.myChart = new Chart(ctx, config);

            // Show the chart container
            document.getElementById("chart-container").style.display = "block";
          });
      }
    </script>
  </body>
</html>
